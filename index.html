<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MaGogmazios Reroll Planner ‚Äì v4</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class'
  }
</script>

<script>
// Apply theme immediately to prevent flash
(function(){
  try{
    const mode = localStorage.getItem("gogma_theme_mode_v1") || "system";
    const isDarkSystem = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    const useDark = (mode==="dark") || (mode==="system" && isDarkSystem);

    if (useDark) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  }catch(e){}
})();
</script>

<style>
  .b-raw{background:#2a2f3a}
  .b-fire{background:#7f1d1d}
  .b-water{background:#0c4a6e}
  .b-thunder{background:#854d0e}
  .b-ice{background:#164e63}
  .b-dragon{background:#4c1d95}
  .b-paralysis{background:#3f6212}
  .b-sleep{background:#115e59}
  .b-blast{background:#7c2d12}
  .b-poison{background:#581c87}
</style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BK6V53Q7YD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-BK6V53Q7YD');
  gtag('consent', 'default', {
	'ad_storage': 'denied',
	'ad_user_data': 'denied',
	'ad_personalization': 'denied',
	'analytics_storage': 'denied'
  });
</script>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
  <header class="sticky top-0 z-10 backdrop-blur bg-slate-50/80 dark:bg-slate-950/80 border-b border-black/10 dark:border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center gap-3 justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-black/5 dark:bg-white/5 border border-black/10 dark:border-white/10 flex items-center justify-center">üõ†Ô∏è</div>
        <div>
          <h1 class="text-lg font-extrabold leading-tight">MaGogmazios Reroll Planner</h1>
          <div class="text-xs text-slate-600 dark:text-slate-300">v4.1</div>
        </div>
      </div>
      
        <div class="flex items-center gap-1 rounded-xl border border-black/10 dark:border-white/10 bg-black/5 dark:bg-white/5 p-1">
          <button id="themeSystem" class="px-2 py-1.5 rounded-lg hover:bg-black/10 dark:hover:bg-white/10 text-xl transition-all" title="System theme">üíª</button>
          <button id="themeLight" class="px-2 py-1.5 rounded-lg hover:bg-black/10 dark:hover:bg-white/10 text-xl transition-all" title="Light theme">‚òÄÔ∏è</button>
          <button id="themeDark" class="px-2 py-1.5 rounded-lg hover:bg-black/10 dark:hover:bg-white/10 text-xl transition-all" title="Dark theme">üåô</button>
        </div>

        <div class="flex items-center gap-2">
        <button id="btnExport" class="px-3 py-2 rounded-xl border border-black/10 dark:border-white/10 bg-black/5 dark:bg-white/5 hover:bg-black/10 dark:hover:bg-white/10 text-sm">Export</button>
        <button id="btnImport" class="px-3 py-2 rounded-xl border border-black/10 dark:border-white/10 bg-black/5 dark:bg-white/5 hover:bg-black/10 dark:hover:bg-white/10 text-sm">Import</button>
        <button id="btnReset" class="px-3 py-2 rounded-xl border border-red-400/30 bg-red-500/10 hover:bg-red-500/15 text-sm">Reset</button>
      </div>
    </div>
  </header>

  <!-- Help Button (fixed bottom right) -->
  <button id="btnHelp" class="fixed bottom-6 right-6 z-50 w-14 h-14 rounded-full bg-sky-500 hover:bg-sky-600 text-white shadow-lg hover:shadow-xl transition-all flex items-center justify-center text-2xl" title="Usage Guide">
    ‚ùì
  </button>

  <!-- Help Overlay -->
  <div id="helpOverlay" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-900 rounded-2xl border border-black/10 dark:border-white/10 max-w-3xl w-full max-h-[90vh] overflow-auto shadow-2xl">
      <div class="sticky top-0 bg-white dark:bg-slate-900 border-b border-black/10 dark:border-white/10 p-6 flex items-center justify-between">
        <h2 class="text-2xl font-extrabold flex items-center gap-3">
          üìñ MaGogmazios Reroll Planner Guide
        </h2>
        <button id="btnCloseHelp" class="w-10 h-10 rounded-xl hover:bg-black/10 dark:hover:bg-white/10 flex items-center justify-center text-2xl transition-all">
          ‚úï
        </button>
      </div>

      <div class="p-6 space-y-6">
        <section>
          <h3 class="text-xl font-bold mb-3 flex items-center gap-2">üéØ What is MaGogmazios Reroll Planner?</h3>
          <p class="text-slate-700 dark:text-slate-300 leading-relaxed">
            Gogmazios weapons have skills and reinforcements determined by <b>predetermined tables based on element type</b>.
            Each weapon (fire lance, dragon lance, etc.) follows a fixed sequence of rolls that doesn't change between attempts.
            This app lets you test and track rolls <b>without saving the game</b>, discovering when desired values appear,
            then optimize the use of rare materials to forge multiple weapons efficiently.
          </p>
        </section>

        <section class="bg-sky-50 dark:bg-sky-950/30 rounded-xl p-4 border border-sky-200 dark:border-sky-800">
          <h3 class="text-xl font-bold mb-3 flex items-center gap-2">üîÑ The Planning Phase</h3>
          <ol class="space-y-3 text-slate-700 dark:text-slate-300">
            <li class="flex gap-3">
              <span class="font-bold text-sky-600 dark:text-sky-400 min-w-[24px]">1.</span>
              <span><b>Add weapons to the app</b> using "+ Add Weapon" and mark them as "Have" (check the box)</span>
            </li>
            <li class="flex gap-3">
              <span class="font-bold text-sky-600 dark:text-sky-400 min-w-[24px]">2.</span>
              <span><b>Set your target values</b> ‚Äî specify which skills and reinforcements you want for each weapon</span>
            </li>
            <li class="flex gap-3">
              <span class="font-bold text-sky-600 dark:text-sky-400 min-w-[24px]">3.</span>
              <span><b>In-game: reroll without saving</b> ‚Äî perform rerolls and use the <b>+ buttons</b> in the app to track each test roll</span>
            </li>
            <li class="flex gap-3">
              <span class="font-bold text-sky-600 dark:text-sky-400 min-w-[24px]">4.</span>
              <span><b>Keep testing until satisfied</b> ‚Äî the + buttons simulate future rolls to find when you'll get desired results</span>
            </li>
            <li class="flex gap-3">
              <span class="font-bold text-sky-600 dark:text-sky-400 min-w-[24px]">5.</span>
              <span><b>Exit without saving</b> and repeat for all weapons you want to modify</span>
            </li>
          </ol>
        </section>

        <section class="bg-green-50 dark:bg-green-950/30 rounded-xl p-4 border border-green-200 dark:border-green-800">
          <h3 class="text-xl font-bold mb-3 flex items-center gap-2">‚úÖ The Execution Phase</h3>
          <ol class="space-y-3 text-slate-700 dark:text-slate-300">
            <li class="flex gap-3">
              <span class="font-bold text-green-600 dark:text-green-400 min-w-[24px]">1.</span>
              <span><b>Check "Next recommended"</b> ‚Äî the app shows which weapon to start with to minimize material usage</span>
            </li>
            <li class="flex gap-3">
              <span class="font-bold text-green-600 dark:text-green-400 min-w-[24px]">2.</span>
              <span><b>Reload your save</b> and start rerolling for real this time</span>
            </li>
            <li class="flex gap-3">
              <span class="font-bold text-green-600 dark:text-green-400 min-w-[24px]">3.</span>
              <span><b>Use the - buttons</b> to track actual rolls as you perform them in-game (this reduces the counters)</span>
            </li>
            <li class="flex gap-3">
              <span class="font-bold text-green-600 dark:text-green-400 min-w-[24px]">4.</span>
              <span><b>Save the game</b> when you get the desired values for each weapon</span>
            </li>
            <li class="flex gap-3">
              <span class="font-bold text-green-600 dark:text-green-400 min-w-[24px]">5.</span>
              <span><b>Move to the next weapon</b> following the app's recommendations to optimize material efficiency</span>
            </li>
          </ol>
        </section>

        <section>
          <h3 class="text-xl font-bold mb-3 flex items-center gap-2">üí° Understanding the Interface</h3>
          <div class="space-y-4">
            <div class="bg-black/5 dark:bg-white/5 rounded-xl p-4">
              <h4 class="font-bold mb-2 flex items-center gap-2">
                <span class="text-2xl">üé≤</span> The Buttons: Skills + / Skills - and Reinf + / Reinf -
              </h4>
              <p class="text-sm text-slate-700 dark:text-slate-300 mb-2">
                <b>S+</b> and <b>R+</b>: Increment counters during <b>planning phase</b> (testing without saving)<br/>
                <b>S-</b> and <b>R-</b>: Decrement counters during <b>execution phase</b> (actual rerolls you'll save)
              </p>
              <p class="text-sm text-slate-600 dark:text-slate-400 italic">
                S = Skills remaining | R = Reinforcements remaining
              </p>
            </div>

            <div class="bg-black/5 dark:bg-white/5 rounded-xl p-4">
              <h4 class="font-bold mb-2 flex items-center gap-2">
                <span class="text-2xl">‚úÖ</span> Next Recommended
              </h4>
              <p class="text-sm text-slate-700 dark:text-slate-300">
                Shows which weapon to work on first to use the least materials. It picks weapons with the smallest remaining counters and skips those already at 0.
              </p>
            </div>

            <div class="bg-black/5 dark:bg-white/5 rounded-xl p-4">
              <h4 class="font-bold mb-2 flex items-center gap-2">
                <span class="text-2xl">üì¶</span> Materials Tracker
              </h4>
              <p class="text-sm text-slate-700 dark:text-slate-300">
                <b>"Devices needed"</b>: Shows how many Tarred Devices you need (3 matching element or 6 any type per skill roll)<br/>
                <b>"Oricalcite needed"</b>: Shows total Oricalcite required (20 per reinforcement roll)<br />
				<b>"Zenny needed"</b>: Shows total Zenny required (9,000z per skill roll, 10,000z per reinforcement roll)
              </p>
            </div>
          </div>
        </section>

        <section class="bg-amber-50 dark:bg-amber-950/30 rounded-xl p-4 border border-amber-200 dark:border-amber-800">
          <h3 class="text-lg font-bold mb-2 flex items-center gap-2">‚ö° Pro Tip: Shared Tables</h3>
          <p class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed">
            Since weapons of the same element share roll tables, testing multiple weapons in parallel helps you map out the entire sequence.
            This way you can strategically plan which weapons to forge in which order, maximizing efficiency by forging multiple weapons
            with desired rolls using the minimum amount of materials.
          </p>
        </section>
		<div class="bg-red-50 dark:bg-red-950/30 rounded-xl p-4 border border-red-200 dark:border-red-800 mt-4">
			<h3 class="text-lg font-bold mb-2 flex items-center gap-2">‚ö†Ô∏è Important Note</h3>
			<p class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed">
			  <b>Do NOT "gogmafy" weapons during the reroll process!</b> Each time you convert an Artian weapon into a Gogmazios weapon ("gogmafication"), the roll table advances by 1. This will throw off your entire planning. Only gogmafy weapons before starting your planning phase or after completing all rerolls.
			</p>
		  </div>		  

        <section class="border-t border-black/10 dark:border-white/10 pt-4">
          <p class="text-xs text-slate-500 dark:text-slate-400 text-center">
            For more details about the mechanics, visit:
            <a href="https://lescarnetsdelawycademie.fr/gogmazios-weapons/" target="_blank" class="text-sky-500 hover:text-sky-600 underline">
              Les Carnets de l'Awycad√©mie
            </a>
          </p>
        </section>
      </div>
    </div>
  </div>

  <main class="max-w-7xl mx-auto px-4 py-4 grid lg:grid-cols-[380px_1fr] gap-3">
    <section class="rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-slate-900/40 p-4 space-y-4 lg:sticky lg:top-[72px] lg:h-[calc(100vh-96px)] lg:overflow-auto">


      <div class="rounded-2xl border border-black/10 dark:border-white/10 bg-black/5 dark:bg-white/5 p-3">
        <div class="flex items-center justify-between">
          <div class="font-extrabold flex items-center gap-2">‚úÖ Next recommended</div>
          <label class="flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300 select-none">
            <input id="onlyTracked" type="checkbox" class="accent-sky-400" />
            Show only tracked
          </label>
        </div>
        <p class="text-xs text-slate-600 dark:text-slate-300 mt-1">Picks the smallest <b>remaining</b> and skips those already at 0.</p>
        <div id="recommendBox" class="mt-3 space-y-2"></div>
      </div>

      <div class="rounded-2xl border border-black/10 dark:border-white/10 bg-black/5 dark:bg-white/5 p-3">
        <div class="font-extrabold flex items-center gap-2">üì¶ Devices needed (Skills)</div>
        <p class="text-xs text-slate-600 dark:text-slate-300 mt-1">Per skill roll: <b>3</b> devices of the same type as focus, or <b>6</b> of any other type.</p>
        <div id="materialsBox" class="mt-3 space-y-2"></div>
      </div>

      <div class="rounded-2xl border border-black/10 dark:border-white/10 bg-black/5 dark:bg-white/5 p-3">
        <div class="font-extrabold flex items-center gap-2">ü™® Oricalcite needed (Reinforcements)</div>
        <p class="text-xs text-slate-600 dark:text-slate-300 mt-1">Per reinforcement reroll: <b>20</b> Oricalcite. Total rolls are shared: <b>max need ‚àí spent</b>.</p>
        <div id="oricalciteBox" class="mt-3 space-y-2"></div>
      </div>

      <div class="rounded-2xl border border-black/10 dark:border-white/10 bg-black/5 dark:bg-white/5 p-3">
        <div class="font-extrabold flex items-center gap-2">üí∞ Zenny needed</div>
        <p class="text-xs text-slate-600 dark:text-slate-300 mt-1">Per skill reroll: <b>9,000z</b>. Per reinforcement reroll: <b>10,000z</b>.</p>
        <div id="zennyBox" class="mt-3 space-y-2"></div>
      </div>
    </section>

    <section class="rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-slate-900/40 p-4">
      <div class="flex flex-wrap items-end justify-between gap-2">
        <div>
          <div class="text-base font-extrabold">Weapons & variants</div>
        </div>
        <button id="expandAll" class="px-3 py-2 rounded-xl bg-black/5 dark:bg-white/5 border border-black/10 dark:border-white/10 hover:bg-black/10 dark:hover:bg-white/10 text-sm">Expand / Collapse all</button>
      </div>

      <div id="weaponList" class="mt-4 space-y-3"></div>
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 py-6 text-center">
    <p class="text-xs text-slate-600 dark:text-slate-400">
      This work is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="noopener noreferrer" class="underline hover:text-slate-900 dark:hover:text-slate-200">Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License</a>
    </p>
  </footer>

  <input type="file" id="filePicker" accept="application/json" class="hidden"/>

<script>
const WEAPONS = [{"name": "Great Sword", "abbr": "GS", "icon": "./images/GS.png"}, {"name": "Long Sword", "abbr": "LS", "icon": "./images/LS.png"}, {"name": "Sword & Shield", "abbr": "SnS", "icon": "./images/SnS.png"}, {"name": "Dual Blades", "abbr": "DB", "icon": "./images/DB.png"}, {"name": "Hammer", "abbr": "HAM", "icon": "./images/HAM.png"}, {"name": "Hunting Horn", "abbr": "HH", "icon": "./images/HH.png"}, {"name": "Lance", "abbr": "LAN", "icon": "./images/LAN.png"}, {"name": "Gunlance", "abbr": "GL", "icon": "./images/GL.png"}, {"name": "Switch Axe", "abbr": "SA", "icon": "./images/SA.png"}, {"name": "Charge Blade", "abbr": "CB", "icon": "./images/CB.png"}, {"name": "Insect Glaive", "abbr": "IG", "icon": "./images/IG.png"}, {"name": "Bow", "abbr": "BOW", "icon": "./images/BOW.png"}, {"name": "Light Bowgun", "abbr": "LBG", "icon": "./images/LBG.png"}, {"name": "Heavy Bowgun", "abbr": "HBG", "icon": "./images/HBG.png"}];
const ELEMENTS = ["Raw", "Fire", "Water", "Thunder", "Ice", "Dragon", "Paralysis", "Sleep", "Blast", "Poison"];
const ARTIAN_TYPES = ["3 Attack", "2 Attack + 1 Affinity", "1 Attack + 2 Affinity", "3 Affinity"];
const FOCUS = ["Attack", "Affinity", "Element"];
const REINF_OPTS = ["", "Attack II", "Attack III", "Attack EX", "Affinity II", "Affinity III", "Affinity EX", "Element II", "Element EX", "Sharpness/Ammo Base", "Sharpness/Ammo EX"];
const MONSTER_TYPE_SKILLS = ["Neopteron Alert / Neopteron Camouflage", "Flexible Leathercraft / Buttery Leathercraft", "Scale Prowess / Scale Layering", "Fortifying Pelt / Alluring Pelt", "Lord\u2019s Favor / Lord\u2019s Fury", "Guardian\u2019s Pulse / Guardian\u2019s Protection", "Imparted Wisdom", "Glory\u2019s Valor", "Lord\u2019s Soul", "Festival Spirit", "Master of the Fist"];
const MONSTER_SKILLS = ["Doshaguma\u2019s Might", "Rey Dau\u2019s Voltage", "Uth Duna\u2019s Cover", "Nu Udra\u2019s Mutiny", "Jin Dahaad\u2019s Revolt", "Rathalos\u2019s Flare", "Gravios\u2019s Protection", "Blangonga\u2019s Spirit", "Gore Magala\u2019s Tyranny", "Guardian Arkveld\u2019s Vitality", "Arkveld\u2019s Hunger", "Ebony Odogaron\u2019s Power", "Fulgur Anjanath\u2019s Will", "Xu Wu\u2019s Vigor", "Mizutsune\u2019s Prowess", "Zoh Shia\u2019s Pulse", "Leviathan\u2019s Fury", "Seregios\u2019s Tenacity", "Soul of the Dark Knight", "Omega Resonance", "Gogmapocalypse", "Prayer skills (Festival armors)"];

// Polyfill for crypto.randomUUID for older browsers
function generateUUID() {
  if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {
    return crypto.randomUUID();
  }
  // Fallback UUID v4 generator
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

const STORAGE_KEY = "gogma_planner_v4";
let state = load();

function makeVariant(element="Raw", artian="3 Attack"){
  return {
    id: generateUUID(),
    element,
    artian,
    have:false,
    done:false,
    focus:"Attack",
    reinf:["","","","",""],
    skillType:"",
    skill:"",
    rollsNeedSkills:0,
    rollsNeedReinf:0,
  };
}

function defaultState(){
  const weapons = {};
  for (const w of WEAPONS) {
    weapons[w.abbr] = {
      open: false,
      variants: ELEMENTS.map(e => makeVariant(e, "3 Attack"))
    };
  }
  return {
    ui: { onlyTracked:false, expanded:false },
    global: { skillSpent:0, reinfSpent:0 },
    weapons
  };
}

function load(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return defaultState();
    const st = JSON.parse(raw);
    if (!st.weapons) return defaultState();
    st.ui ??= {onlyTracked:false, expanded:false};
    st.global ??= {skillSpent:0, reinfSpent:0};
    for (const w of WEAPONS) {
      st.weapons[w.abbr] ??= {open:false, variants:[]};
      const ww = st.weapons[w.abbr];
      ww.open ??= false;
      ww.variants ??= [];
      if (!ww.variants.length) ww.variants = ELEMENTS.map(e => makeVariant(e, "3 Attack"));
      for (const v of ww.variants) {
        v.id ??= generateUUID();
        v.element ??= "Raw";
        v.artian ??= "3 Attack";
        v.have ??= false; v.done ??= false;
        v.focus ??= "Attack";
        v.reinf ??= ["","","","",""];
        if (v.reinf.length !== 5) v.reinf = (v.reinf.concat(["","","","",""])).slice(0,5);
        v.skillType ??= "";
        v.skill ??= "";
        v.rollsNeedSkills = Number(v.rollsNeedSkills||0);
        v.rollsNeedReinf = Number(v.rollsNeedReinf||0);
      }
      // Sort variants by element order only when loading
      ww.variants.sort((a, b) => {
        const indexA = ELEMENTS.indexOf(a.element);
        const indexB = ELEMENTS.indexOf(b.element);
        return indexA - indexB;
      });
    }
    return st;
  } catch(e) {
    console.warn(e);
    return defaultState();
  }
}

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

const $ = (s)=>document.querySelector(s);
const esc = (s)=>String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[m]));
function elemClass(e){
  const m = {
    Raw:"b-raw",Fire:"b-fire",Water:"b-water",Thunder:"b-thunder",Ice:"b-ice",Dragon:"b-dragon",
    Paralysis:"b-paralysis",Sleep:"b-sleep",Blast:"b-blast",Poison:"b-poison"
  };
  return m[e] || "b-raw";
}
function elemIcon(e){
  const m = {
    Raw:"üçñ",Fire:"üî•",Water:"üíß",Thunder:"‚ö°",Ice:"‚ùÑÔ∏è",Dragon:"üêâ",
    Paralysis:"ü´®",Sleep:"üí§",Blast:"üí•",Poison:"‚ò†Ô∏è"
  };
  return m[e] || "üçñ";
}

function remaining(v){
  const remS = Math.max(0, Number(v.rollsNeedSkills||0) - state.global.skillSpent);
  const remR = Math.max(0, Number(v.rollsNeedReinf||0) - state.global.reinfSpent);
  return {remS, remR, total: remS + remR};
}

function hasTargets(v){
  return (v.have || v.done || v.rollsNeedSkills>0 || v.rollsNeedReinf>0 || v.skillType || v.skill || (v.reinf||[]).some(x=>x));
}
function caresReinf(v){ return (v.rollsNeedReinf > 0) || (v.reinf||[]).some(x=>x); }
function caresSkills(v){ return (v.rollsNeedSkills > 0) || !!v.skillType || !!v.skill; }

function renderKPIs(){
  // Global counters removed - now handled per weapon
}

function recommendCard(title, best, short, key){
  if (!best) {
    return `<div class="px-3 py-2 rounded-2xl border border-emerald-400/30 bg-emerald-500/10 text-sm font-semibold">${title}: none pending üéâ</div>`;
  }
  const metric = best.r[key];
  return `
    <div class="rounded-2xl border border-sky-400/30 bg-sky-500/10 p-3">
      <div class="text-xs text-slate-600 dark:text-slate-300 mb-1">${title} ‚Äì next</div>
      <div class="flex items-center gap-2 flex-wrap">
        <img src="${best.w.icon}" class="w-6 h-6" alt="icon"/>
        <div class="font-extrabold">${esc(best.w.name)}</div>
        <span class="px-2 py-1 rounded-full text-xs border border-black/10 dark:border-white/10 text-white ${elemClass(best.v.element)}">${esc(best.v.element)}</span>
        <span class="px-2 py-1 rounded-full text-xs border border-black/10 dark:border-white/10 bg-black/5 dark:bg-white/5">${esc(best.v.artian)}</span>
        <span class="px-2 py-1 rounded-full text-xs border border-emerald-400/30 bg-emerald-500/10">${short} remaining: <b>${metric}</b></span>
      </div>
      <button class="mt-3 px-3 py-2 rounded-xl bg-black/5 dark:bg-white/5 border border-black/10 dark:border-white/10 hover:bg-black/10 dark:hover:bg-white/10 text-sm" onclick="jumpTo('${best.w.abbr}')">Jump</button>
    </div>
  `;
}

function renderRecommendation(){
  let bestR = null;
  let bestS = null;

  for (const w of WEAPONS) {
    for (const v of state.weapons[w.abbr].variants) {
      if (v.done) continue;
      if (state.ui.onlyTracked && !hasTargets(v)) continue;
      const r = remaining(v);

      if (caresReinf(v) && r.remR > 0) {
        if (!bestR || r.remR < bestR.r.remR) bestR = {w,v,r};
      }
      if (caresSkills(v) && r.remS > 0) {
        if (!bestS || r.remS < bestS.r.remS) bestS = {w,v,r};
      }
    }
  }

  $("#recommendBox").innerHTML =
    recommendCard("‚öôÔ∏è Reinforcements", bestR, "R", "remR") +
    recommendCard("üé≤ Skills", bestS, "S", "remS");
}

function jumpTo(abbr){
  state.weapons[abbr].open = true;
  save();
  renderList();
  const el = document.querySelector(`[data-w="${abbr}"]`);
  el?.scrollIntoView({behavior:"smooth", block:"start"});
}

function renderMaterials(){
  // IMPORTANT:
  // Rolls are SHARED (global counter), but materials are spent ONLY on the weapon you roll on.
  // So the TOTAL rolls needed to satisfy ALL targets is: max(need) - spent (NOT a sum).
  // We estimate materials by simulating a simple optimal-ish plan:
  // always spend the next roll on the weapon that will finish the soonest (smallest need still > counter).

  const items = [];
  for (const w of WEAPONS) {
    for (const v of state.weapons[w.abbr].variants) {
      if (v.done) continue;
      if (state.ui.onlyTracked && !hasTargets(v)) continue;
      if (!caresSkills(v)) continue;
      const need = Number(v.rollsNeedSkills||0);
      if (need <= 0) continue;
      items.push({ w, v, need, focus: (v.focus || "Attack") });
    }
  }

  const maxNeed = items.reduce((mx, it)=>Math.max(mx, it.need), 0);
  const steps = Math.max(0, maxNeed - state.global.skillSpent);

  // Simulate from current counter to maxNeed-1
  const counts = {Attack:0, Affinity:0, Element:0};

  for (let i=0; i<steps; i++){
    const c = state.global.skillSpent + i;
    // eligible: still needs rolls at counter c
    let best = null;
    for (const it of items){
      if (it.need <= c) continue;
      if (!best || it.need < best.need) best = it;
    }
    if (!best) break;
    counts[best.focus] = (counts[best.focus]||0) + 1;
  }

  function card(focus){
    const r = counts[focus] || 0;
    const same = r * 3;
    const other = r * 6;
    const non = ["Attack","Affinity","Element"].filter(x=>x!==focus);
    return `
      <div class="rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-black/20 p-3">
        <div class="flex items-center justify-between">
          <div class="font-extrabold">${focus} focus</div>
          <span class="text-xs text-slate-600 dark:text-slate-300">rolls: <b>${r}</b></span>
        </div>
        <div class="mt-2 grid grid-cols-3 gap-2 text-xs">
          <div class="px-2 py-2 rounded-xl border border-emerald-400/30 bg-emerald-500/10">
            <div class="text-slate-200 font-semibold">3√ó same</div>
            <div class="mt-1"><b>${same}</b> ${focus} devices</div>
          </div>
          <div class="px-2 py-2 rounded-xl border border-black/10 dark:border-white/10 bg-black/5 dark:bg-white/5">
            <div class="text-slate-200 font-semibold">6√ó other</div>
            <div class="mt-1"><b>${other}</b> ${non[0]} devices</div>
          </div>
          <div class="px-2 py-2 rounded-xl border border-black/10 dark:border-white/10 bg-black/5 dark:bg-white/5">
            <div class="text-slate-200 font-semibold">6√ó other</div>
            <div class="mt-1"><b>${other}</b> ${non[1]} devices</div>
          </div>
        </div>
      </div>
    `;
  }

  const box = $("#materialsBox");
  if (steps === 0){
    box.innerHTML = `<div class="px-3 py-2 rounded-2xl border border-emerald-400/30 bg-emerald-500/10 text-sm font-semibold">No pending skill rolls üéâ</div>`;
    return;
  }
  box.innerHTML = `
    <div class="text-xs text-slate-600 dark:text-slate-300 mb-2">Total skill rolls you will perform (shared counter): <b>${steps}</b> (max need ‚àí spent)</div>
  ` + card("Attack") + card("Affinity") + card("Element");
}

function renderOricalcite(){
  // Reinforcement rerolls use Oricalcite: 20 per roll.
  // Rolls are shared (global counter), but Oricalcite is spent only on the weapon you roll on.
  // Total rolls needed for ALL targets: max(need) - spent.

  const items = [];
  for (const w of WEAPONS) {
    for (const v of state.weapons[w.abbr].variants) {
      if (v.done) continue;
      if (state.ui.onlyTracked && !hasTargets(v)) continue;
      if (!caresReinf(v)) continue;
      const need = Number(v.rollsNeedReinf||0);
      if (need <= 0) continue;
      items.push({ w, v, need });
    }
  }

  const maxNeed = items.reduce((mx, it)=>Math.max(mx, it.need), 0);
  const steps = Math.max(0, maxNeed - state.global.reinfSpent);
  const totalOricalcite = steps * 20;

  const box = $("#oricalciteBox");
  if (steps === 0){
    box.innerHTML = `<div class="px-3 py-2 rounded-2xl border border-emerald-400/30 bg-emerald-500/10 text-sm font-semibold">No pending reinforcement rolls üéâ</div>`;
    return;
  }

  // Optional: show a simple "finish smallest first" plan counts per weapon variant (collapsed summary)
  // We'll just show total, and the next weapon to roll for reinf.
  let next = null;
  for (const it of items){
    if (it.need > state.global.reinfSpent){
      if (!next || it.need < next.need) next = it;
    }
  }

  box.innerHTML = `
    <div class="rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-black/20 p-3">
      <div class="flex items-center justify-between">
        <div class="font-extrabold">Total reinforcement rolls to perform</div>
        <span class="text-xs text-slate-600 dark:text-slate-300"><b>${steps}</b> rolls</span>
      </div>
      <div class="mt-2 text-sm">
        Oricalcite: <span class="font-extrabold">${totalOricalcite}</span>
        <span class="text-xs text-slate-600 dark:text-slate-300">(20 √ó ${steps})</span>
      </div>
      ${next ? `
        <div class="mt-3 text-xs text-slate-600 dark:text-slate-300">Next (finish smallest first):</div>
        <div class="mt-1 flex items-center gap-2 flex-wrap">
          <img src="${next.w.icon}" class="w-6 h-6" alt="icon"/>
          <div class="font-semibold">${esc(next.w.name)}</div>
          <span class="px-2 py-1 rounded-full text-xs border border-black/10 dark:border-white/10 text-white ${elemClass(next.v.element)}">${esc(next.v.element)}</span>
          <span class="px-2 py-1 rounded-full text-xs border border-black/10 dark:border-white/10 bg-black/5 dark:bg-white/5">${esc(next.v.artian)}</span>
          <span class="px-2 py-1 rounded-full text-xs border border-emerald-400/30 bg-emerald-500/10">R remaining: <b>${Math.max(0, next.need - state.global.reinfSpent)}</b></span>
        </div>
      ` : ``}
    </div>
  `;
}

function findVariant(id){
  for (const w of WEAPONS) {
    const v = state.weapons[w.abbr].variants.find(x=>x.id===id);
    if (v) return v;
  }
  return null;
}

function renderList(){
  const list = $("#weaponList");
  list.innerHTML = "";

  for (const w of WEAPONS) {
    const ww = state.weapons[w.abbr];
    const variants = ww.variants;
    const filtered = variants.filter(v => state.ui.onlyTracked ? hasTargets(v) : true);

    const haveCount = variants.filter(v=>v.have).length;
    const doneCount = variants.filter(v=>v.done).length;
    const trackedCount = variants.filter(v=>hasTargets(v)).length;

    const headerTint = doneCount>0 ? "border-emerald-400/20" : "border-black/10 dark:border-white/10";

    const card = document.createElement("div");
    card.className = `rounded-2xl border ${headerTint} bg-black/5 dark:bg-white/5`;
    card.dataset.w = w.abbr;

    card.innerHTML = `
      <button class="w-full p-4 flex items-center gap-3 text-left" data-toggle="${w.abbr}">
        <img src="${w.icon}" class="w-7 h-7" alt="icon"/>
        <div>
          <div class="font-extrabold flex items-center gap-2">
            ${esc(w.name)}
            ${doneCount>0 ? `<span class="text-[11px] px-2 py-0.5 rounded-full border border-emerald-400/30 bg-emerald-500/10">done: ${doneCount}</span>` : ""}
          </div>
          <div class="text-xs text-slate-600 dark:text-slate-300">${esc(w.abbr)} ¬∑ ${trackedCount} tracked</div>
        </div>
        <div class="ml-auto flex flex-wrap gap-2 text-xs">
          <span class="px-2 py-1 rounded-full border border-black/10 dark:border-white/10 bg-white/70 dark:bg-black/20">Have: <b>${haveCount}</b></span>
          <span class="px-2 py-1 rounded-full border border-emerald-400/30 bg-emerald-500/10">Rolled: <b>${doneCount}</b></span>
        </div>
      </button>

      <div class="${ww.open ? "" : "hidden"}">
        <div class="px-4 pb-4">
          <div class="flex flex-wrap items-center gap-2 mb-3">
            <button class="px-3 py-2 rounded-xl bg-black/5 dark:bg-white/5 border border-black/10 dark:border-white/10 hover:bg-black/10 dark:hover:bg-white/10 text-sm" data-add="${w.abbr}">Ôºã Add variant</button>
            <span class="text-xs text-slate-600 dark:text-slate-300">Make multiple copies (element/artian).</span>
          </div>

          <div class="space-y-3">
            ${filtered.map(v=>{
              const r = remaining(v);
              const counts = {};
              for (const x of (v.reinf||[])) { if (!x) continue; counts[x]=(counts[x]||0)+1; }
              const badRule = Object.values(counts).some(c=>c>2);
              const variantTint = v.done ? "border-emerald-400/30 bg-emerald-500/5" : (v.have ? "border-sky-400/20 bg-sky-500/5" : "border-black/10 dark:border-white/10 bg-white/70 dark:bg-black/20");
              return `
                <div class="rounded-2xl border ${variantTint} p-3">
                  <div class="flex flex-wrap items-center gap-2">
                    <select data-k="element" data-id="${v.id}" class="px-3 py-2 rounded-xl bg-white dark:bg-black/30 border border-black/10 dark:border-white/10 text-sm text-slate-900 dark:text-slate-100">
                      ${ELEMENTS.map(e=>`<option value="${esc(e)}"${e===v.element?" selected":""}>${esc(e)}</option>`).join("")}
                    </select>
                    <select data-k="artian" data-id="${v.id}" class="px-3 py-2 rounded-xl bg-white dark:bg-black/30 border border-black/10 dark:border-white/10 text-sm text-slate-900 dark:text-slate-100">
                      ${ARTIAN_TYPES.map(a=>`<option value="${esc(a)}"${a===v.artian?" selected":""}>${esc(a)}</option>`).join("")}
                    </select>

                    <span class="px-2 py-1 rounded-full text-xs border border-black/10 dark:border-white/10 text-white ${elemClass(v.element)}">${elemIcon(v.element)} ${esc(v.element)}</span>
                    <span class="px-2 py-1 rounded-full text-xs border border-black/10 dark:border-white/10 bg-black/5 dark:bg-white/5">${esc(v.artian)}</span>

                    <span class="ml-auto flex items-center gap-3 text-xs text-slate-600 dark:text-slate-300">
                      <label class="flex items-center gap-2 select-none"><input data-k="have" data-id="${v.id}" type="checkbox" class="accent-sky-400" ${v.have?"checked":""}/>Have</label>
                      <label class="flex items-center gap-2 select-none"><input data-k="done" data-id="${v.id}" type="checkbox" class="accent-emerald-400" ${v.done?"checked":""}/>Rolled</label>
                    </span>
                  </div>

                  <div class="mt-3 grid md:grid-cols-3 gap-3">
                    <div>
                      <div class="text-xs text-slate-600 dark:text-slate-300 mb-1">Gog Focus</div>
                      <select data-k="focus" data-id="${v.id}" class="w-full px-3 py-2 rounded-xl bg-white dark:bg-black/30 border border-black/10 dark:border-white/10 text-sm text-slate-900 dark:text-slate-100">
                        ${FOCUS.map(f=>`<option value="${esc(f)}"${f===v.focus?" selected":""}>${esc(f)}</option>`).join("")}
                      </select>
                    </div>

                    <div>
                      <div class="text-xs text-slate-600 dark:text-slate-300 mb-1">Rolls needed</div>
                      <div class="grid grid-cols-2 gap-2">
                        <div>
                          <div class="text-[11px] text-slate-500 dark:text-slate-400 mb-1">Skills</div>
                          <input data-k="rollsNeedSkills" data-id="${v.id}" type="number" min="0" value="${v.rollsNeedSkills||0}" class="w-full px-3 py-2 rounded-xl bg-white dark:bg-black/30 border border-black/10 dark:border-white/10 text-sm text-slate-900 dark:text-slate-100"/>
                        </div>
                        <div>
                          <div class="text-[11px] text-slate-500 dark:text-slate-400 mb-1">Reinf</div>
                          <input data-k="rollsNeedReinf" data-id="${v.id}" type="number" min="0" value="${v.rollsNeedReinf||0}" class="w-full px-3 py-2 rounded-xl bg-white dark:bg-black/30 border border-black/10 dark:border-white/10 text-sm text-slate-900 dark:text-slate-100"/>
                        </div>
                      </div>
                    </div>

                    <div>
                      <div class="text-xs text-slate-600 dark:text-slate-300 mb-1">Remaining</div>
                      <div class="flex flex-wrap gap-2 text-xs">
                        <span class="px-2 py-1 rounded-full border border-black/10 dark:border-white/10 bg-black/5 dark:bg-white/5">Skills: <b>${r.remS}</b></span>
                        <span class="px-2 py-1 rounded-full border border-black/10 dark:border-white/10 bg-black/5 dark:bg-white/5">Reinf: <b>${r.remR}</b></span>
                        <span class="px-2 py-1 rounded-full border border-emerald-400/30 bg-emerald-500/10">Total: <b>${r.total}</b></span>
                      </div>
                    </div>
                  </div>

                  <div class="mt-3">
                    <div class="flex items-center justify-between mb-1">
                      <div class="text-xs text-slate-600 dark:text-slate-300">Desired Reinforcements (5)</div>
                      <button data-act="godroll" data-id="${v.id}" class="px-3 py-1.5 rounded-xl bg-gradient-to-r from-amber-500/20 to-yellow-500/20 border border-amber-400/40 hover:from-amber-500/30 hover:to-yellow-500/30 text-xs font-semibold flex items-center gap-1.5 text-amber-700 dark:text-amber-300 transition-all">
                        <span>‚≠ê</span>
                        <span>Set God Roll</span>
                      </button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-2">
                      ${(v.reinf||[]).map((cur, idx)=>`
                        <select data-k="reinf:${idx}" data-id="${v.id}" class="w-full px-3 py-2 rounded-xl bg-white dark:bg-black/30 border border-black/10 dark:border-white/10 text-sm text-slate-900 dark:text-slate-100">
                          ${REINF_OPTS.map(o=>`<option value="${esc(o)}"${o===cur?" selected":""}>${esc(o||"‚Äî")}</option>`).join("")}
                        </select>
                      `).join("")}
                    </div>
                    <div class="mt-2 text-xs">
                      ${badRule
                        ? '<span class="px-2 py-1 rounded-full border border-red-400/30 bg-red-500/10">Rule: max 2 same violated</span>'
                        : '<span class="px-2 py-1 rounded-full border border-emerald-400/30 bg-emerald-500/10">Rule: OK</span>'
                      }
                    </div>
                  </div>

                  <div class="mt-3">
                    <div class="text-xs text-slate-600 dark:text-slate-300 mb-1">Desired Skills (2)</div>
                    <div class="grid md:grid-cols-2 gap-2">
					  <select data-k="skill" data-id="${v.id}" class="w-full px-3 py-2 rounded-xl bg-white dark:bg-black/30 border border-black/10 dark:border-white/10 text-sm text-slate-900 dark:text-slate-100">
						  <option value="">‚Äî Monster skill ‚Äî</option>
						  ${MONSTER_SKILLS.map(s=>`<option value="${esc(s)}"${s===v.skill?" selected":""}>${esc(s)}</option>`).join("")}
					  </select>
                      <select data-k="skillType" data-id="${v.id}" class="w-full px-3 py-2 rounded-xl bg-white dark:bg-black/30 border border-black/10 dark:border-white/10 text-sm text-slate-900 dark:text-slate-100">
                        <option value="">‚Äî Monster type skill ‚Äî</option>
                        ${MONSTER_TYPE_SKILLS.map(s=>`<option value="${esc(s)}"${s===v.skillType?" selected":""}>${esc(s)}</option>`).join("")}
                      </select>
                    </div>
                  </div>

                  <div class="mt-3 rounded-xl border border-black/10 dark:border-white/10 bg-black/5 dark:bg-white/5 p-3">
                    <div class="flex items-center gap-2 mb-2">
                      <span>üé≤</span>
                      <span class="font-extrabold text-sm">Roll management</span>
                    </div>
                    <div class="text-xs text-slate-600 dark:text-slate-300 space-y-1 mb-3">
                      <div><b>+</b> = simulate a reroll <i>(exit without saving)</i></div>
                      <div><b>‚àí</b> = commit the reroll <i>(save & advance seed)</i></div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                      <button data-act="s+" class="px-3 py-2 rounded-xl bg-black/5 dark:bg-white/5 border border-black/10 dark:border-white/10 hover:bg-black/10 dark:hover:bg-white/10 text-sm flex items-center gap-1" data-id="${v.id}">
                        <span>üîÑ</span>
                        <span>Skills +</span>
                      </button>
                      <button data-act="s-" class="px-3 py-2 rounded-xl bg-black/5 dark:bg-white/5 border border-black/10 dark:border-white/10 hover:bg-black/10 dark:hover:bg-white/10 text-sm flex items-center gap-1" data-id="${v.id}">
                        <span>üíæ</span>
                        <span>Skills -</span>
                      </button>
                      <div class="w-0.5 h-10 bg-black/20 dark:bg-white/20 self-center mx-3 rounded-full"></div>
                      <button data-act="r+" class="px-3 py-2 rounded-xl bg-black/5 dark:bg-white/5 border border-black/10 dark:border-white/10 hover:bg-black/10 dark:hover:bg-white/10 text-sm flex items-center gap-1" data-id="${v.id}">
                        <span>üîÑ</span>
                        <span>Reinf +</span>
                      </button>
                      <button data-act="r-" class="px-3 py-2 rounded-xl bg-black/5 dark:bg-white/5 border border-black/10 dark:border-white/10 hover:bg-black/10 dark:hover:bg-white/10 text-sm flex items-center gap-1" data-id="${v.id}">
                        <span>üíæ</span>
                        <span>Reinf -</span>
                      </button>
                    </div>
                  </div>
                  <div class="mt-2 flex justify-end">
                    <button data-act="del" class="px-3 py-2 rounded-xl bg-red-500/10 border border-red-400/30 hover:bg-red-500/15 text-sm" data-id="${v.id}">Delete</button>
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        </div>
      </div>
    `;

    list.appendChild(card);
  }

  document.querySelectorAll("[data-toggle]").forEach(btn=>{
    btn.onclick = ()=>{
      const abbr = btn.dataset.toggle;
      state.weapons[abbr].open = !state.weapons[abbr].open;
      save();
      renderList();
    };
  });

  document.querySelectorAll("[data-add]").forEach(btn=>{
    btn.onclick = ()=>{
      const abbr = btn.dataset.add;
      state.weapons[abbr].variants.unshift(makeVariant("Raw","3 Attack"));
      state.weapons[abbr].open = true;
      save();
      renderAll();
    };
  });

  document.querySelectorAll("[data-id]").forEach(el=>{
    const id = el.dataset.id;
    const k = el.dataset.k;
    const act = el.dataset.act;

    if (act) {
      el.onclick = ()=>{
        // Roll management:
        // + = simulate a reroll (exit without saving) - only affects this variant
        // - = commit the reroll (save & advance seed) - affects ALL variants
        if (act==="del") {
          if (!confirm("Are you sure you want to delete this weapon variant? This action cannot be undone.")) {
            return;
          }
          for (const w of WEAPONS) {
            const arr = state.weapons[w.abbr].variants;
            const idx = arr.findIndex(v=>v.id===id);
            if (idx>=0) { arr.splice(idx,1); break; }
          }
          save(); renderAll();
          return;
        }

        const v = findVariant(id);
        if (!v) return;

        if (act==="s+") {
          // Simulate a skill reroll - only increment target for this variant
          v.rollsNeedSkills = Number(v.rollsNeedSkills||0) + 1;
        }
        if (act==="s-") {
          // Commit a skill reroll - decrement target for ALL variants
          for (const w of WEAPONS) {
            state.weapons[w.abbr].variants.forEach(variant => {
              variant.rollsNeedSkills = Math.max(0, Number(variant.rollsNeedSkills||0) - 1);
            });
          }
        }
        if (act==="r+") {
          // Simulate a reinf reroll - only increment target for this variant
          v.rollsNeedReinf = Number(v.rollsNeedReinf||0) + 1;
        }
        if (act==="r-") {
          // Commit a reinf reroll - decrement target for ALL variants
          for (const w of WEAPONS) {
            state.weapons[w.abbr].variants.forEach(variant => {
              variant.rollsNeedReinf = Math.max(0, Number(variant.rollsNeedReinf||0) - 1);
            });
          }
        }
        if (act==="godroll") {
          // Set God Roll configuration
          v.reinf = ["Attack EX", "Attack EX", "Attack III", "Attack III", "Sharpness/Ammo EX"];
          v.skill = "Gore Magala\u2019s Tyranny";
          v.skillType = "Lord\u2019s Soul";
        }

        save(); renderAll();
      };
      return;
    }

    if (el.tagName==="INPUT" && el.type==="checkbox") {
      el.onchange = (ev)=>{
        const v = findVariant(id); if (!v) return;
        v[k] = ev.target.checked;
        save(); renderAll();
      };
    } else if (el.tagName==="INPUT" && el.type==="number") {
      el.oninput = (ev)=>{
        const v = findVariant(id); if (!v) return;
        v[k] = Number(ev.target.value||0);
        save(); renderAll();
      };
    } else if (el.tagName==="SELECT") {
      el.onchange = (ev)=>{
        const v = findVariant(id); if (!v) return;
        if (k && k.startsWith("reinf:")) {
          const idx = Number(k.split(":")[1]);
          v.reinf[idx] = ev.target.value;
        } else {
          v[k] = ev.target.value;
        }
        save(); renderAll();
      };
    }
  });
}

function renderZenny(){
  // Calculate total Zenny needed: 9,000z per skill reroll + 10,000z per reinforcement reroll

  // Calculate skill rerolls needed using same logic as renderMaterials
  const skillItems = [];
  for (const w of WEAPONS) {
    for (const v of state.weapons[w.abbr].variants) {
      if (v.done) continue;
      if (state.ui.onlyTracked && !hasTargets(v)) continue;
      if (!caresSkills(v)) continue;
      const need = Number(v.rollsNeedSkills||0);
      if (need > 0) skillItems.push(need);
    }
  }
  const maxSkillNeed = skillItems.reduce((mx, n)=>Math.max(mx, n), 0);
  const totalSkillRolls = Math.max(0, maxSkillNeed - state.global.skillSpent);

  // Calculate reinforcement rerolls needed
  const reinfItems = [];
  for (const w of WEAPONS) {
    for (const v of state.weapons[w.abbr].variants) {
      if (v.done) continue;
      if (state.ui.onlyTracked && !hasTargets(v)) continue;
      if (!caresReinf(v)) continue;
      const need = Number(v.rollsNeedReinf||0);
      if (need > 0) reinfItems.push(need);
    }
  }
  const maxReinfNeed = reinfItems.reduce((mx, n)=>Math.max(mx, n), 0);
  const totalReinfRolls = Math.max(0, maxReinfNeed - state.global.reinfSpent);

  const skillZenny = totalSkillRolls * 9000;
  const reinfZenny = totalReinfRolls * 10000;
  const totalZenny = skillZenny + reinfZenny;

  const box = $("#zennyBox");
  if (totalZenny === 0){
    box.innerHTML = `<div class="px-3 py-2 rounded-2xl border border-emerald-400/30 bg-emerald-500/10 text-sm font-semibold">No pending rerolls üéâ</div>`;
    return;
  }

  box.innerHTML = `
    <div class="rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-black/20 p-3">
      <div class="flex items-center justify-between mb-2">
        <div class="font-extrabold">Total Zenny needed</div>
        <span class="font-extrabold text-lg">${totalZenny.toLocaleString()}z</span>
      </div>
      <div class="text-xs text-slate-600 dark:text-slate-300 space-y-1">
        ${totalSkillRolls > 0 ? `<div>‚Ä¢ Skills: ${skillZenny.toLocaleString()}z (${totalSkillRolls} √ó 9,000z)</div>` : ''}
        ${totalReinfRolls > 0 ? `<div>‚Ä¢ Reinforcements: ${reinfZenny.toLocaleString()}z (${totalReinfRolls} √ó 10,000z)</div>` : ''}
      </div>
    </div>
  `;
}

function renderAll(){
  renderKPIs();
  renderRecommendation();
  renderMaterials();
  renderOricalcite();
  renderZenny();
  renderList();
}


$("#onlyTracked").checked = !!state.ui.onlyTracked;
$("#onlyTracked").onchange = (e)=>{ state.ui.onlyTracked = e.target.checked; save(); renderAll(); };

$("#expandAll").onclick = ()=>{
  const next = !state.ui.expanded;
  state.ui.expanded = next;
  for (const w of WEAPONS) state.weapons[w.abbr].open = next;
  save();
  renderList();
};

function download(filename, text) {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([text], {type:"application/json"}));
  a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
}
$("#btnExport").onclick = ()=>{
  const stamp = new Date().toISOString().slice(0,19).replaceAll(":","-");
  download(`gogma_planner_v4_${stamp}.json`, JSON.stringify(state, null, 2));
};
$("#btnImport").onclick = ()=>$("#filePicker").click();
$("#filePicker").onchange = async (e)=>{
  const f = e.target.files[0]; if (!f) return;
  const txt = await f.text();
  try {
    state = JSON.parse(txt);
    save();
    renderAll();
  } catch(err) {
    alert("Import failed: " + err.message);
  } finally {
    e.target.value = "";
  }
};
$("#btnReset").onclick = ()=>{
  if (!confirm("Reset everything?")) return;
  state = defaultState();
  save();
  renderAll();
};


// Theme (light / dark / system)
const THEME_KEY = "gogma_theme_mode_v1";

function applyTheme(mode){
  const root = document.documentElement;
  const isDarkSystem = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
  const useDark = (mode==="dark") || (mode==="system" && isDarkSystem);

  // Remove and add class explicitly for better compatibility
  if (useDark) {
    root.classList.remove("dark"); // Remove first to force re-render
    void root.offsetHeight; // Force reflow
    root.classList.add("dark");
  } else {
    root.classList.add("dark"); // Add first to force re-render
    void root.offsetHeight; // Force reflow
    root.classList.remove("dark");
  }

  // Force browser to repaint
  root.style.display = 'none';
  void root.offsetHeight;
  root.style.display = '';
}

function getTheme(){
  return localStorage.getItem(THEME_KEY) || "system";
}

function setTheme(mode){
  localStorage.setItem(THEME_KEY, mode);
  applyTheme(mode);
  updateThemeButtons();
}

function updateThemeButtons(){
  const current = getTheme();
  const btnSystem = $("#themeSystem");
  const btnLight = $("#themeLight");
  const btnDark = $("#themeDark");

  if (!btnSystem || !btnLight || !btnDark) return;

  // Reset all buttons
  [btnSystem, btnLight, btnDark].forEach(btn => {
    btn.classList.remove("bg-black/20", "dark:bg-white/20");
    btn.style.opacity = "0.6";
  });

  // Highlight active button
  let activeBtn = null;
  if (current === "system") activeBtn = btnSystem;
  if (current === "light") activeBtn = btnLight;
  if (current === "dark") activeBtn = btnDark;

  if (activeBtn) {
    activeBtn.classList.add("bg-black/20", "dark:bg-white/20");
    activeBtn.style.opacity = "1";
  }
}

// Initialize theme when DOM is ready
function initTheme(){
  const cur = getTheme();
  applyTheme(cur);
  updateThemeButtons();

  // Theme button handlers
  const btnSystem = $("#themeSystem");
  const btnLight = $("#themeLight");
  const btnDark = $("#themeDark");

  if (btnSystem) btnSystem.onclick = ()=>setTheme("system");
  if (btnLight) btnLight.onclick = ()=>setTheme("light");
  if (btnDark) btnDark.onclick = ()=>setTheme("dark");

  // Listen for system theme changes
  if (window.matchMedia){
    window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ()=>{
      if (getTheme() === "system") {
        applyTheme("system");
      }
    });
  }
}

// Call init function
initTheme();

// Help overlay functionality
const btnHelp = $("#btnHelp");
const btnCloseHelp = $("#btnCloseHelp");
const helpOverlay = $("#helpOverlay");

if (btnHelp && helpOverlay && btnCloseHelp) {
  btnHelp.onclick = () => {
    helpOverlay.classList.remove("hidden");
  };

  btnCloseHelp.onclick = () => {
    helpOverlay.classList.add("hidden");
  };

  // Close overlay when clicking on the backdrop
  helpOverlay.onclick = (e) => {
    if (e.target === helpOverlay) {
      helpOverlay.classList.add("hidden");
    }
  };

  // Close overlay with ESC key
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !helpOverlay.classList.contains("hidden")) {
      helpOverlay.classList.add("hidden");
    }
  });
}

renderAll();
</script>
</body>
</html>
